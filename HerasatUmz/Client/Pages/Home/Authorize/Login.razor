@page "/"
@using Application.DTOs.User.Auth
@inherits BaseComponent


<!-- bootstrap rtl -->
<link rel="stylesheet" href="/dist/css/bootstrap-rtl.min.css">
<!-- template rtl version -->
<link rel="stylesheet" href="/dist/css/custom-style.css">

<body class="hold-transition login-page">
    <div class="login-box">
        <div class="login-logo">
            <a href=""><b>ورود به سایت</b></a>
        </div>
        <!-- /.login-logo -->
        <div class="card">
            <div class="card-body login-card-body">
                <p class="login-box-msg">فرم زیر را تکمیل کنید و ورود بزنید</p>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                     <p class="login-box-msg">@errorMessage</p>
                }
                <form action="../../index2.html" method="post">
                    <div class="input-group mb-3">
                        <input @bind="username" type="number" class="form-control" placeholder="کد ملی">
                        <div class="input-group-append">
                            <span class="fa fa-id-card input-group-text"></span>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="password" @bind="password" class="form-control" placeholder="رمز عبور">
                        <div class="input-group-append">
                            <span class="fa fa-lock input-group-text"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <button type="submit" @onclick="LoginAsync" disabled="@isLoading" class="btn btn-primary btn-block btn-flat">ورود</button>
                        </div>
                    </div>
                </form>

                <div class="social-auth-links text-center mb-3">
                    <p>تیم نرم افزاری دانشگاه مازندران</p>
                </div>
            </div>
        </div>
    </div>
    <!-- /.login-box -->

    <script>
        $(function () {
          $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass   : 'iradio_square-blue',
            increaseArea : '20%' // optional
          })
        })
    </script>
</body>


@code {
    private string username = "";
    private string password = "";
    private string errorMessage = "";
    private bool isLoading = false;

    private async Task LoginAsync()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            LoginDto loginDto = new LoginDto
                {
                    CodeId = username,
                    Password = password
                };

            var response = await Http.PostAsJsonAsync("api/auth/Login", loginDto);

            if (response.IsSuccessStatusCode)
            {
                LoginResponseDto user = await response.Content.ReadFromJsonAsync<LoginResponseDto>();

                // await _localStorage.SetItemAsync("access_token", user.Tokenaccess);
                Navigation.NavigateTo("/Panel");
            }
            else
            {
                var text = await response.Content.ReadAsStringAsync();
                errorMessage = $"مشکل در ورود به سایت";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"سرور-مشکل در ورود به سایت";

        }
        finally
        {
            isLoading = false;
        }
    }
}
