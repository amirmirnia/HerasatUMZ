@page "/panel/visitors/ListExitedVisitors"
@attribute [Authorize]
@layout PanelLayout
@inherits BaseComponent

<PageTitle>ملاقات‌کنندگان خارج شده</PageTitle>

<ImageModal @ref="imageModal" OnClose="() => StateHasChanged()" />


<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>افراد خارج شده از دانشگاه</h1>
            </div>
        </div>
    </div>
</section>
<div class="row">
    <div class="col-12">
        <!-- فیلتر و جستجو -->
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter"></i> فیلتر و جستجو</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" @onclick="ClearFilters">
                        <i class="fas fa-repeat"></i> پاک کردن
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>جستجو</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input type="text" class="form-control" placeholder="نام، کد ملی یا ملاقات‌شونده..."
                                @bind="searchQuery" @bind:event="oninput" @bind:after="LoadVisitors" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label>از تاریخ ورود</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                </div>
                                <input id="checkIn"
                                type="text"
                                class="form-control"
                                data-jdp
                                data-jdp-miladi-input="miladi_dateS"
                                placeholder="انتخاب تاریخ ورود"
                                autocomplete="off"
                                value="@DateTime.Now.ToPeString("yyyy/MM/dd")"
                                @onchange="UpdateCheckInDate" />
                                <input id="miladi_dateS" type="hidden" @bind="MiladiCheckIn" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label>تا تاریخ خروج</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                </div>
                                <input id="checkOut"
                                type="text"
                                class="form-control"
                                data-jdp
                                data-jdp-miladi-input="miladi_dateE"
                                placeholder="شمسی"
                                autocomplete="off"
                                @onchange="UpdateCheckOutDate" />
                                <input id="miladi_dateE" type="hidden" @bind="MiladiCheckOut" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- جدول بازدیدکنندگان -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> ملاقات‌کنندگان خارج شده از دانشگاه
                </h3>
            </div>
            <div class="card-body table-responsive p-0">
                @if (isLoading)
                {
                    <div class="overlay">
                        <i class="fas fa-3x fa-sync-alt fa-spin"></i>
                    </div>
                }
                else if (visitors == null || !visitors.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-users-slash fa-3x text-muted"></i>
                        <p class="mt-3 text-muted">هیچ ملاقات‌کننده‌ای در حال حاضر حضور ندارد.</p>
                    </div>
                }
                else
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>عکس</th>
                                <th>نام کامل</th>
                                <th>کد ملی</th>
                                <th>پلاک</th>
                                <th>ملاقات‌شونده</th>
                                <th>شماره تماس</th>
                                <th>زمان ورود</th>
                                <th>زمان خروج</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in visitors)
                            {
                                <tr>
                                    <td>
                                        <img src="@GetVisitorImage(v.PhotoPath)"
                                        class="img-circle elevation-2"
                                        alt="@v.FullName"
                                        style="width:50px;height:50px;object-fit:cover;" />
                                    </td>
                                    <td><strong>@v.FullName</strong></td>
                                    <td>@v.NationalCode</td>
                                    <td>
                                        @{
                                            if (!string.IsNullOrEmpty(v.Vehicles.PlatePart1))
                                            {
                                                <div class="plate-tooltip">
                                                    <i class="fas fa-car text-primary"></i>
                                                    <span class="tooltiptext">
                                                        <Plate Part1="@v.Vehicles.PlatePart1"
                                                        Letter="@v.Vehicles.PlateLetter.GetDescription()"
                                                        Part3="@v.Vehicles.PlatePart3"
                                                        Part4="@v.Vehicles.PlatePart4" />
                                                    </span>
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">بدون وسیله</span>
                                            }
                                        }
                                    </td>
                                    <td>@v.HostName</td>
                                    <td dir="ltr">@v.PhoneNumber</td>
                                    <td>@v.RegisterDateTime.ToPeString("yyyy/MM/dd - HH:mm")</td>
                                    <td>@v.ExitDateTime?.ToPeString("yyyy/MM/dd - HH:mm")</td>
                                    <td>
                                        @{
                                            if (!string.IsNullOrEmpty(v.Vehicles.PlatePart1))
                                            {
                                                <button class="btn btn-info btn-sm"
                                                        @onclick="() => ShowVehicleImage(v.Vehicles.VehiclePhotoPath)"
                                                        title="نمایش عکس ماشین">
                                                    <i class="fas fa-image"></i> ماشین
                                                </button>
                                            }
                                            <button class="btn btn-info btn-sm"
                                                    @onclick="() => GetVisitorImage(v.PhotoPath)"
                                                    title="نمایش عکس شخص">
                                                <i class="fas fa-image"></i> شخص
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    @if (totalPages > 1)
                    {
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mt-3">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PrevPage">قبلی</button>
                                </li>
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    var page = i;
                                    <li class="page-item @(i == currentPage ? "active" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(page)">@i</button>
                                    </li>
                                }
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="NextPage">بعدی</button>
                                </li>
                            </ul>
                        </nav>
                    }
                }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private PagedResult<VisitorVM>? Allvisitor;
    private List<VisitorVM> visitors = new();
    private ConfirmModal? confirmModal;
    private int pendingVisitorId;
    private string pendingVisitorName = "";
    private ImageModal? imageModal;
    private string searchQuery = "";
    private string MiladiCheckIn = DateTime.Now.ToString();
    private string MiladiCheckOut = "";
    private bool isLoading = true;

    private int currentPage = 1;
    private int pageSize = 5;
    private int totalRecords = 0;
    private int totalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVisitors();
        await JSRuntime.InvokeVoidAsync("jalaliDatepicker.startWatch");
        await InitializeDatepicker();

        // SignalR: ورود جدید
        hubConnection.On<VisitorVM>("VisitorRegistered", visitor =>
        {
            visitors ??= new();
            visitors.Insert(0, visitor);
            StateHasChanged();
        });

        // SignalR: خروج
        hubConnection.On<int>("VisitorExited", id =>
        {
            var exited = visitors?.FirstOrDefault(x => x.Id == id);
            if (exited != null)
            {
                visitors!.Remove(exited);
                StateHasChanged();
            }
        });


    }

    private async Task LoadVisitors()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            DateTime? checkIn = null;
            DateTime? checkOut = null;

            if (!string.IsNullOrEmpty(MiladiCheckIn) && DateTime.TryParse(MiladiCheckIn, out var parsedCheckIn))
            {
                checkIn = parsedCheckIn;
            }

            if (!string.IsNullOrEmpty(MiladiCheckOut) && DateTime.TryParse(MiladiCheckOut, out var parsedCheckOut))
            {
                checkOut = parsedCheckOut;
            }


            var model = new SearchVisitorsDro
                {
                    pageNumber = currentPage,
                    pageSize = pageSize,
                    IsInside = false,
                    searchQuery = searchQuery,
                    EnterTime = checkIn ?? DateTime.UtcNow,
                    ExitTime = checkOut,
                };

            var response = await Http.PostAsJsonAsync("api/visitors/GetAllVisitors", model);
            if (response.IsSuccessStatusCode)
            {
                Allvisitor = await response.Content.ReadFromJsonAsync<PagedResult<VisitorVM>>();
                visitors = Allvisitor.Items ?? new();
                totalRecords = Allvisitor.TotalCount;
            }
            else
            {
                _AlertService.Show("خطا در دریافت اطلاعات بازدیدکنندگان", "هشدار", AlertType.Error);

            }
        }
        catch (Exception ex)
        {
            _AlertService.Show("خطا در ارتباط با سرور: ", "هشدار", AlertType.Error);

        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        searchQuery = "";
        MiladiCheckIn = "";
        MiladiCheckOut = "";
        await LoadVisitors();
    }
    private async Task UpdateCheckInDate(ChangeEventArgs e)
    {
        MiladiCheckIn = await JSRuntime.InvokeAsync<string>("eval", "document.getElementById('miladi_dateS').value");
        await LoadVisitors();
        StateHasChanged();
    }

    private async Task UpdateCheckOutDate(ChangeEventArgs e)
    {
        MiladiCheckOut = await JSRuntime.InvokeAsync<string>("eval", "document.getElementById('miladi_dateE').value");
        await LoadVisitors();
        StateHasChanged();
    }
    private async Task InitializeDatepicker()
    {
        // تنظیم رویداد jdp:change برای به‌روزرسانی تاریخ میلادی
        await JSRuntime.InvokeVoidAsync("eval", @"
            document.querySelectorAll('[data-jdp-miladi-input]').forEach(function (element) {
                element.addEventListener('jdp:change', function (e) {
                    var miladiInput = document.getElementById(this.getAttribute('data-jdp-miladi-input'));
                    if (!this.value) {
                        miladiInput.value = '';
                        return;
                    }
                    var date = this.value.split('/');
                    miladiInput.value = jalali_to_gregorian(date[0], date[1], date[2]).join('-');
                });
            });

            function jalali_to_gregorian(jy, jm, jd) {
                jy = Number(jy);
                jm = Number(jm);
                jd = Number(jd);
                var gy = (jy <= 979) ? 621 : 1600;
                jy -= (jy <= 979) ? 0 : 979;
                var days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4))
                    + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
                gy += 400 * (parseInt(days / 146097));
                days %= 146097;
                if (days > 36524) {
                    gy += 100 * (parseInt(--days / 36524));
                    days %= 36524;
                    if (days >= 365) days++;
                }
                gy += 4 * (parseInt((days) / 1461));
                days %= 1461;
                gy += parseInt((days - 1) / 365);
                if (days > 365) days = (days - 1) % 365;
                var gd = days + 1;
                var sal_a = [0, 31, ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                var gm;
                for (gm = 0; gm < 13; gm++) {
                    var v = sal_a[gm];
                    if (gd <= v) break;
                    gd -= v;
                }
                return [gy, gm, gd];
            }
        ");
    }



    private string GetVisitorImage(string? imagename)
    {
        if (!string.IsNullOrEmpty(imagename)) return $"/uploads/visitors/{imagename}";
        return $"/";
    }
    private void ShowVehicleImage(string? imagename)
    {
        var url = !string.IsNullOrEmpty(imagename)
            ? $"/uploads/Vehiclevisitors/{imagename}"
            : null;

        imageModal?.Show(url);
    }
    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadVisitors();
    }

    private async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadVisitors();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadVisitors();
        }
    }
}