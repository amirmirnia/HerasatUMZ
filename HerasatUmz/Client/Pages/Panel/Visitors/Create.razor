@page "/panel/visitors/create"
@using Domain.Enums
@attribute [Authorize]
@layout PanelLayout
@inherits BaseComponent
@implements IDisposable
<PageTitle>ثبت ملاقات‌کننده</PageTitle>

<!-- Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>ثبت ملاقات‌کننده</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-left">
                    <li class="breadcrumb-item"><a href="/panel">خانه</a></li>
                    <li class="breadcrumb-item active">ثبت ملاقات‌کننده</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Messages -->
@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show mt-3">
        <i class="fas fa-check-circle"></i> @SuccessMessage
        <button type="button" class="close" @onclick="() => SuccessMessage = null">
            <span>&times;</span>
        </button>
    </div>
}
@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show mt-3">
        <i class="fas fa-exclamation-triangle"></i> @ErrorMessage
        <button type="button" class="close" @onclick="() => ErrorMessage = null">
            <span>&times;</span>
        </button>
    </div>
}

<!-- Main Card -->
<div class="card card-primary card-outline">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-user-plus"></i> ثبت ملاقات‌کننده جدید
        </h3>
    </div>
    <div class="card-body">
        <EditForm Model="visitor" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="row">
                <!-- نام کامل -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label>نام و نام خانوادگی <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                            </div>
                            <InputText @bind-Value="visitor.FullName" class="form-control" placeholder="مثال: علی رضایی" />
                        </div>
                        <ValidationMessage For="@(() => visitor.FullName)" class="text-danger" />
                    </div>
                </div>

                <!-- کد ملی -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label>کد ملی <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                            </div>
                            <InputText @bind-Value="visitor.NationalCode" class="form-control" placeholder="۱۰ رقم" />
                        </div>
                        <ValidationMessage For="@(() => visitor.NationalCode)" class="text-danger" />
                    </div>
                </div>

                <!-- نام ملاقات‌شونده -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label>نام ملاقات‌شونده</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                            </div>
                            <InputText @bind-Value="visitor.HostName" class="form-control" placeholder="مثال: مهندس احمدی" />
                        </div>
                    </div>
                </div>

                <!-- شماره همراه -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label>شماره همراه</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            </div>
                            <InputText @bind-Value="visitor.PhoneNumber" class="form-control" placeholder="۰۹xxxxxxxxx" />
                        </div>
                        <ValidationMessage For="@(() => visitor.PhoneNumber)" class="text-danger" />
                    </div>
                </div>

                <!-- وب‌کم و عکس -->
                <div class="col-md-6">
                    <div class="webcam-container text-center">
                        <video id="webcamVideo" autoplay playsinline style="width: 100%; max-height: 300px; border: 2px solid #ddd; border-radius: 8px;"></video>
                        <canvas id="webcamCanvas" style="display: none;"></canvas>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" @onclick="StartWebcam" disabled="@isRunning">
                            <i class="fas fa-video"></i> شروع وب‌کم
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="StopWebcam" disabled="@(!isRunning)">
                            <i class="fas fa-video-slash"></i> توقف
                        </button>
                        <button type="button" class="btn btn-info" @onclick="TakePhoto" disabled="@(!isRunning)">
                            <i class="fas fa-camera"></i> عکس گرفتن
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(previewImage))
                    {
                        <div class="mt-3 text-center">
                            <h5 class="text-success">پیش‌نمایش عکس</h5>
                            <img src="@previewImage" alt="پیش‌نمایش" style="max-width: 100%; max-height: 250px; border: 2px solid #007bff; border-radius: 8px;" />
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ClearPhoto">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- بخش خودرو -->
            <div class="form-group mt-4">
                <label class="d-flex align-items-center">
                    <InputCheckbox @bind-Value="visitor.HasVehicle" class="mr-2" />
                    <i class="fas fa-car"></i> ثبت اطلاعات خودرو (اختیاری)
                </label>
            </div>

            @if (visitor.HasVehicle)
            {
                <div class="card card-warning card-outline mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-car-side"></i> اطلاعات خودرو
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- پلاک ایرانی -->
                            <div class="col-md-6">
                                <label>پلاک خودرو <span class="text-danger">*</span></label>
                                <div class="license-plate-container mb-3">
                                    <div class="license-plate">
                                        <div class="left-section">
                                            <div class="flag"></div>
                                            <div class="country">
                                                <span>I.R.</span>
                                                <span>IRAN</span>
                                            </div>
                                        </div>
                                        <div class="main-section">
                                            <div class="numbers">
                                                <div class="digit">@(visitor.PlatePart1 ?? "--")</div>
                                                <div class="letter">@(visitor.PlateLetter?.GetDescription() ?? "الف")</div>
                                                <div class="digit">@(visitor.PlatePart3 ?? "--")</div>
                                            </div>
                                        </div>
                                        <div class="right-section">
                                            <div class="code">@(visitor.PlatePart4 ?? "--")</div>
                                            <div class="label">ایران</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-3">
                                        <InputText @bind-Value="visitor.PlatePart1" class="form-control text-center" placeholder="۱۲" maxlength="2" />
                                        <ValidationMessage For="@(() => visitor.PlatePart1)" class="text-danger" />
                                    </div>
                                    <div class="col-3">
                                        <InputSelect @bind-Value="visitor.PlateLetter" class="form-control text-center">
                                            <option value="">حرف</option>
                                            @foreach (var letter in Enum.GetValues(typeof(PlateLetter)).Cast<PlateLetter>())
                                            {
                                                <option value="@letter">@letter.GetDescription()</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-3">
                                        <InputText @bind-Value="visitor.PlatePart3" class="form-control text-center" placeholder="۳۴" maxlength="3" />
                                        <ValidationMessage For="@(() => visitor.PlatePart3)" class="text-danger" />
                                    </div>
                                    <div class="col-3">
                                        <InputText @bind-Value="visitor.PlatePart4" class="form-control text-center" placeholder="۵۶" maxlength="2" />
                                        <ValidationMessage For="@(() => visitor.PlatePart4)" class="text-danger" />
                                    </div>
                                </div>
                            </div>

                            <!-- نوع، رنگ، برند -->
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>نوع خودرو</label>
                                            <InputSelect @bind-Value="visitor.VehicleType" class="form-control">
                                                <option value="">انتخاب کنید</option>
                                                @foreach (var type in Enum.GetValues(typeof(VehicleType)).Cast<VehicleType>())
                                                {
                                                    <option value="@type">@type.GetDescription()</option>
                                                }
                                            </InputSelect>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>رنگ خودرو</label>
                                            <InputText @bind-Value="visitor.Color" class="form-control" placeholder="مثال: سفید" />
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label>برند خودرو</label>
                                            <InputText @bind-Value="visitor.Brand" class="form-control" placeholder="مثال: پراید" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- وب‌کم پلاک -->
                            <div class="col-md-6 mt-3">
                                <div class="webcam-container text-center">
                                    <video id="@PlateVideoElementId" autoplay playsinline style="width: 100%; max-height: 250px; border: 2px solid #ffc107; border-radius: 8px;"></video>
                                    <canvas id="@PlateCanvasElementId" style="display: none;"></canvas>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-success btn-sm" @onclick="StartPlateWebcam" disabled="@isPlateCamRunning">
                                        <i class="fas fa-video"></i> شروع
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" @onclick="StopPlateWebcam" disabled="@(!isPlateCamRunning)">
                                        <i class="fas fa-video-slash"></i> توقف
                                    </button>
                                    <button type="button" class="btn btn-info btn-sm" @onclick="TakePlatePhoto" disabled="@(!isPlateCamRunning)">
                                        <i class="fas fa-camera"></i> عکس
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(previewVehicleImage))
                                {
                                    <div class="mt-2 text-center">
                                        <h6 class="text-warning">پیش‌نمایش پلاک</h6>
                                        <img src="@previewVehicleImage" style="max-width: 100%; max-height: 150px; border: 2px solid #ffc107; border-radius: 8px;" />
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" @onclick="ClearPlatePhoto">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Buttons -->
            <div class="text-right mt-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" @onclick='() => Navigation.NavigateTo("/panel/visitors")'>
                    <i class="fas fa-arrow-left"></i> انصراف
                </button>
                <button type="submit" class="btn btn-primary btn-lg ml-2" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                        }
                    else
                    {
                        <span>ذخیره</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private VisitorDto visitor = new();
    private string? previewImage;
    private string? previewVehicleImage;
    private bool isSubmitting = false;
    private string? SuccessMessage;
    private string? ErrorMessage;
    private bool isRunning = false;

    private const string VideoElementId = "webcamVideo";
    private const string CanvasElementId = "webcamCanvas";

    private const string PlateVideoElementId = "plateWebcamVideo";
    private const string PlateCanvasElementId = "plateWebcamCanvas";
    private bool isPlateCamRunning = false;

 

    private void ClearPhoto()
    {
        visitor.PhotoBase64 = null;
        previewImage = null;
        StateHasChanged();
    }

    private async Task HandleSubmit(EditContext context)
    {
        // اعتبارسنجی شرطی برای ماشین
        if (visitor.HasVehicle)
        {
            if (string.IsNullOrWhiteSpace(visitor.PlatePart1) ||
                string.IsNullOrWhiteSpace(visitor.PlateLetter.ToString()) ||
                string.IsNullOrWhiteSpace(visitor.PlatePart3) ||
                string.IsNullOrWhiteSpace(visitor.PlatePart4))
            {
                ErrorMessage = "لطفاً تمام قسمت‌های پلاک را وارد کنید.";
                return;
            }
        }

        if (!context.Validate()) return;

        isSubmitting = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            var response = await Http.PostAsJsonAsync("api/visitors/register", visitor);
            if (response.IsSuccessStatusCode)
            {
                SuccessMessage = "ملاقات‌کننده با موفقیت ثبت شد.";
                await Task.Delay(1500);
                Navigation.NavigateTo("/panel/visitors");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ErrorMessage = error;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "خطا در ارتباط با سرور: " + ex.Message;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

       private async Task StartWebcam()
    {
        var result = await JSRuntime.InvokeAsync<bool>("startWebcam", VideoElementId);
        if (result)
        {
            isRunning = true;
            ErrorMessage = null;
        }
        else
        {
            ErrorMessage = "دسترسی به وب‌کم امکان‌پذیر نیست. لطفاً مجوز را بررسی کنید.";
        }
    }

    private async Task StopWebcam()
    {
        await JSRuntime.InvokeVoidAsync("stopWebcam", VideoElementId);
        isRunning = false;
    }

    private async Task TakePhoto()
    {
        try
        {
            var base64 = await JSRuntime.InvokeAsync<string>("takePhoto", VideoElementId, CanvasElementId);
            if (!string.IsNullOrEmpty(base64) && base64.Contains(','))
            {
                visitor.PhotoBase64 = base64.Split(',')[1]; // فقط Base64
                previewImage = base64; // برای نمایش
                StateHasChanged();

                SuccessMessage = "عکس با موفقیت گرفته شد.";
                ErrorMessage = null;
            }
            else
            {
                ErrorMessage = "خطا در گرفتن عکس.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "خطا در گرفتن عکس: " + ex.Message;
        }
    }

    private async Task StartPlateWebcam()
    {
        var result = await JSRuntime.InvokeAsync<bool>("startWebcam", PlateVideoElementId);
        if (result)
        {
            isPlateCamRunning = true;
            ErrorMessage = null;
        }
        else
        {
            ErrorMessage = "دسترسی به وب‌کم پلاک امکان‌پذیر نیست.";
        }
    }

    private async Task StopPlateWebcam()
    {
        await JSRuntime.InvokeVoidAsync("stopWebcam", PlateVideoElementId);
        isPlateCamRunning = false;
    }

    private async Task TakePlatePhoto()
    {
        try
        {
            var base64 = await JSRuntime.InvokeAsync<string>("takePhoto", PlateVideoElementId, PlateCanvasElementId);
            if (!string.IsNullOrEmpty(base64) && base64.Contains(','))
            {
                visitor.VehiclePhotoBase64 = base64.Split(',')[1];
                previewVehicleImage = base64;
                StateHasChanged();
                SuccessMessage = "عکس پلاک گرفته شد.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "خطا در عکس پلاک: " + ex.Message;
        }
    }

    private void ClearPlatePhoto()
    {
        visitor.VehiclePhotoBase64 = null;
        previewVehicleImage = null;
        StateHasChanged();
    }


    public void Dispose()
    {
        if (isRunning)
        {
            _ = JSRuntime.InvokeVoidAsync("stopWebcam", VideoElementId);
        }
    }
}