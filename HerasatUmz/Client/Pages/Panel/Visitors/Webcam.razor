@page "/create"
@inject IJSRuntime JS

<h3>ثبت ملاقات‌کننده</h3>

<div class="webcam-container position-relative">
    <video id="webcamVideo" autoplay playsinline style="width: 100%; max-height: 300px; border: 2px solid #ddd; border-radius: 8px;"></video>
    <canvas id="faceOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
    <canvas id="webcamCanvas" style="display: none;"></canvas>
</div>

<div class="mt-3">
    <button type="button" class="btn btn-success" @onclick="StartWebcam" disabled="@isRunning">
        شروع وب‌کم
    </button>
    <button type="button" class="btn btn-danger" @onclick="StopWebcam" disabled="@(!isRunning)">
        توقف
    </button>
    <button type="button" class="btn btn-info" @onclick="TakePhoto" disabled="@(!isRunning)">
        عکس گرفتن
    </button>
</div>

@if (!string.IsNullOrEmpty(previewImage))
{
    <div class="mt-3">
        <h5>پیش‌نمایش صورت</h5>
        <img src="@previewImage" style="max-width: 250px; border: 2px solid green;" />
    </div>
}

@code {
    private string? previewImage;
    private bool isRunning = false;
    private const string VideoId = "webcamVideo";
    private const string OverlayId = "faceOverlay";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initFaceDetection");
        }
    }

    private async Task StartWebcam()
    {
        var ok = await JS.InvokeAsync<bool>("startWebcam", VideoId);
        if (ok)
        {
            isRunning = true;
            await JS.InvokeVoidAsync("startFaceOverlay", VideoId, OverlayId);
        }
    }

    private async Task StopWebcam()
    {
        await JS.InvokeVoidAsync("stopWebcam", VideoId);
        await JS.InvokeVoidAsync("stopFaceOverlay");
        isRunning = false;
    }

    private async Task TakePhoto()
    {
        var base64 = await JS.InvokeAsync<string>("captureFaceOnly", VideoId);
        if (base64 != null)
        {
            previewImage = base64;
            // visitor.PhotoBase64 = base64.Split(',')[1];
        }
        else
        {
           
        }
    }
}