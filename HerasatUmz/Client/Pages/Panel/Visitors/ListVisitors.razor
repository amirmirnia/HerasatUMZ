@page "/panel/visitors"
@attribute [Authorize]
@layout PanelLayout
@inherits BaseComponent

<PageTitle>ملاقات‌کنندگان حاضر</PageTitle>

<ConfirmModal @ref="confirmModal" OnClose="HandleConfirmResult" />
<ImageModal @ref="imageModal" OnClose="() => StateHasChanged()" />



<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>افراد حاضر در دانشگاه</h1>
            </div>
        </div>
    </div>
</section>


<div class="row">
    <div class="col-12">
        <!-- فیلتر و جستجو -->
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter"></i> فیلتر و جستجو</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" @onclick="ClearFilters">
                        <i class="fas fa-repeat"></i> پاک کردن
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>جستجو</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input type="text" class="form-control" placeholder="نام، کد ملی یا ملاقات‌شونده..."
                                       @bind="searchQuery" @bind:event="oninput" @bind:after="LoadVisitors" />
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- جدول بازدیدکنندگان -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> ملاقات‌کنندگان حاضر در دانشگاه
                    <span class="badge badge-success ml-2">@(visitors?.Count ?? 0) نفر</span>
                </h3>
            </div>
            <div class="card-body table-responsive p-0">
                @if (isLoading)
                {
                    <div class="overlay">
                        <i class="fas fa-3x fa-sync-alt fa-spin"></i>
                    </div>
                }
                else if (visitors == null || !visitors.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-users-slash fa-3x text-muted"></i>
                        <p class="mt-3 text-muted">هیچ ملاقات‌کننده‌ای در حال حاضر حضور ندارد.</p>
                    </div>
                }
                else
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>عکس</th>
                                <th>نام کامل</th>
                                <th>کد ملی</th>
                                <th>پلاک</th>
                                <th>ملاقات‌شونده</th>
                                <th>شماره تماس</th>
                                <th>زمان ورود</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in visitors)
                            {
                                <tr>
                                    <td>
                                        <img src="@GetVisitorImage(v.PhotoPath)"
                                             class="img-circle elevation-2"
                                             alt="@v.FullName"
                                             style="width:50px;height:50px;object-fit:cover;" />
                                    </td>
                                    <td><strong>@v.FullName</strong></td>
                                    <td>@v.NationalCode</td>
                                    <td>
                                        @{
                                            if (!string.IsNullOrEmpty(v.Vehicles.PlatePart1))
                                            {
                                                <div class="plate-tooltip">
                                                    <i class="fas fa-car text-primary"></i>
                                                    <span class="tooltiptext">
                                                        <Plate Part1="@v.Vehicles.PlatePart1"
                                                               Letter="@v.Vehicles.PlateLetter.GetDescription()"
                                                               Part3="@v.Vehicles.PlatePart3"
                                                               Part4="@v.Vehicles.PlatePart4" />
                                                    </span>
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">بدون وسیله</span>
                                            }
                                        }
                                    </td>
                                    <td>@v.HostName</td>
                                    <td dir="ltr">@v.PhoneNumber</td>
                                    <td>@v.RegisterDateTime.ToPeString("yyyy/MM/dd - HH:mm")</td>
                                    <td>
                                        @{
                                            if (!string.IsNullOrEmpty(v.Vehicles.PlatePart1))
                                            {
                                                <button class="btn btn-info btn-sm"
                                                        @onclick="() => ShowVehicleImage(v.Vehicles.VehiclePhotoPath)"
                                                        title="نمایش عکس پلاک">
                                                    <i class="fas fa-image"></i> نمایش
                                                </button>
                                            }
                                        }
                                        <button class="btn btn-danger btn-sm ml-1"
                                                @onclick="() => ConfirmExit(v.Id, v.FullName)">
                                            <i class="fas fa-sign-out-alt"></i> خروج
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    @if (totalPages > 1)
                    {
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mt-3">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PrevPage">قبلی</button>
                                </li>
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    var page = i;
                                    <li class="page-item @(i == currentPage ? "active" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(page)">@i</button>
                                    </li>
                                }
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="NextPage">بعدی</button>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private PagedResult<VisitorVM>? Allvisitor;
    private List<VisitorVM> visitors = new();

    private ConfirmModal? confirmModal;
    private int pendingVisitorId;
    private string pendingVisitorName = "";
    private ImageModal? imageModal;
    private string searchQuery = "";
    private string MiladiCheckIn = "";
    private string MiladiCheckOut = "";
    private bool isLoading = true;

    private int currentPage = 1;
    private int pageSize = 5;
    private int totalRecords = 0;
    private int totalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVisitors();
        await JSRuntime.InvokeVoidAsync("jalaliDatepicker.startWatch");
        // SignalR: ورود جدید


        hubConnection.On<VisitorVM>("VisitorRegistered", id =>
        {
            _AlertService.Show($"{id.FullName} وارد سازمان شد", "موفقیت", AlertType.Success);
            visitors.Insert(0, id);
            StateHasChanged();
        });

        // SignalR: خروج
        hubConnection.On<int>("VisitorExited", id =>
        {
            var exited = visitors?.FirstOrDefault(x => x.Id == id);
            if (exited != null)
            {
                visitors!.Remove(exited);
                StateHasChanged();
            }
        });


    }

    private async Task LoadVisitors()
    {
        isLoading = true;
        StateHasChanged();

        try
        {


            var model = new SearchVisitorsDro
                {
                    IsInside = true,
                    pageNumber = currentPage,
                    pageSize = pageSize,
                    searchQuery = searchQuery,


                };

            var response = await Http.PostAsJsonAsync("api/visitors/GetAllVisitors", model);
            if (response.IsSuccessStatusCode)
            {
                Allvisitor = await response.Content.ReadFromJsonAsync<PagedResult<VisitorVM>>();
                visitors = Allvisitor.Items ?? new();
                totalRecords = Allvisitor.TotalCount;
            }
            else
            {
                _AlertService.Show("خطا در دریافت اطلاعات بازدیدکنندگان", "هشدار", AlertType.Error);
            }
        }
        catch (Exception ex)
        {
            _AlertService.Show("خطا در ارتباط با سرور:", "هشدار", AlertType.Error);

        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        searchQuery = "";
        MiladiCheckIn = "";
        MiladiCheckOut = "";
        await LoadVisitors();
    }


    private void ConfirmExit(int id, string name)
    {
        pendingVisitorId = id;
        pendingVisitorName = name;
        confirmModal?.Show("تأیید خروج", $"آیا از خروج {name}اطمینان دارید؟");
    }

    private async Task HandleConfirmResult(bool confirmed)
    {
        if (!confirmed) return;

        var response = await Http.PostAsJsonAsync("api/visitors/ExitVisitor", new { Id = pendingVisitorId });
        if (!response.IsSuccessStatusCode)
        {
            _AlertService.Show("خطا در ثبت خروج", "هشدار", AlertType.Error);
        }
        // SignalR خودش حذف می‌کند
    }

    private string GetVisitorImage(string? imagename)
    {
        if (!string.IsNullOrEmpty(imagename)) return $"/uploads/visitors/{imagename}";
        return $"/Avatar.png";
    }

    private void ShowVehicleImage(string? imagename)
    {
        var url = !string.IsNullOrEmpty(imagename)
            ? $"/uploads/Vehiclevisitors/{imagename}"
            : null;

        imageModal?.Show(url);
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadVisitors();
    }

    private async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadVisitors();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadVisitors();
        }
    }
}