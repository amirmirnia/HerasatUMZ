@page "/panel/visitors"
@using Client.Components
@layout PanelLayout
@inherits BaseComponent

<PageTitle>ملاقات‌کنندگان حاضر</PageTitle>

<ConfirmModal @ref="confirmModal" OnClose="HandleConfirmResult" />

@if (!string.IsNullOrEmpty(errorMessage))
{
    <Toast Message="@errorMessage" Type="toastType" Duration="5000" />
}

<div class="row">
    <div class="col-12">
        <!-- فیلتر و جستجو -->
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter"></i> فیلتر و جستجو</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" @onclick="ClearFilters">
                        <i class="fas fa-repeat"></i> پاک کردن
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>جستجو</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input type="text" class="form-control" placeholder="نام، کد ملی یا ملاقات‌شونده..."
                                @bind="searchQuery" @bind:event="oninput" @bind:after="LoadVisitors" />
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- جدول بازدیدکنندگان -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> ملاقات‌کنندگان حاضر در دانشگاه
                    <span class="badge badge-success ml-2">@(visitors?.Count ?? 0) نفر</span>
                </h3>
            </div>
            <div class="card-body table-responsive p-0">
                @if (isLoading)
                {
                    <div class="overlay">
                        <i class="fas fa-3x fa-sync-alt fa-spin"></i>
                    </div>
                }
                else if (visitors == null || !visitors.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-users-slash fa-3x text-muted"></i>
                        <p class="mt-3 text-muted">هیچ ملاقات‌کننده‌ای در حال حاضر حضور ندارد.</p>
                    </div>
                }
                else
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>عکس</th>
                                <th>نام کامل</th>
                                <th>کد ملی</th>
                                <th>ملاقات‌شونده</th>
                                <th>شماره تماس</th>
                                <th>زمان ورود</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in visitors)
                            {
                                <tr>
                                    <td>
                                        <img src="@GetVisitorImage(v.PhotoPath)"
                                        class="img-circle elevation-2"
                                        alt="@v.FullName"
                                        style="width:50px;height:50px;object-fit:cover;" />
                                    </td>
                                    <td><strong>@v.FullName</strong></td>
                                    <td>@v.NationalCode</td>
                                    <td>@v.HostName</td>
                                    <td dir="ltr">@v.PhoneNumber</td>
                                    <td>@v.RegisterDateTime.ToPeString("yyyy/MM/dd - HH:mm")</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm"
                                        @onclick="() => ConfirmExit(v.Id, v.FullName)">
                                            <i class="fas fa-sign-out-alt"></i> خروج
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<VisitorVM>? visitors;
    private ConfirmModal? confirmModal;
    private int pendingVisitorId;
    private string pendingVisitorName = "";
    private string searchQuery = "";
    private string MiladiCheckIn = "";
    private string MiladiCheckOut = "";
    private bool isLoading = true;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVisitors();
        await JSRuntime.InvokeVoidAsync("jalaliDatepicker.startWatch");
        // SignalR: ورود جدید
        hubConnection.On<VisitorVM>("VisitorRegistered", visitor =>
        {
            visitors ??= new();
            visitors.Insert(0, visitor);
            StateHasChanged();
        });

        // SignalR: خروج
        hubConnection.On<int>("VisitorExited", id =>
        {
            var exited = visitors?.FirstOrDefault(x => x.Id == id);
            if (exited != null)
            {
                visitors!.Remove(exited);
                StateHasChanged();
            }
        });

        
    }

    private async Task LoadVisitors()
    {
        isLoading = true;
        StateHasChanged();

        try
        {


            var model = new SearchVisitorsDro
                {
                    IsInside = true,
                    searchQuery = searchQuery,

                };

            var response = await Http.PostAsJsonAsync("api/visitors/GetAllVisitors", model);
            if (response.IsSuccessStatusCode)
            {
                visitors = await response.Content.ReadFromJsonAsync<List<VisitorVM>>();
            }
            else
            {
                errorMessage = "خطا در دریافت اطلاعات بازدیدکنندگان";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "خطا در ارتباط با سرور: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        searchQuery = "";
        MiladiCheckIn = "";
        MiladiCheckOut = "";
        await JSRuntime.InvokeVoidAsync("eval", "document.querySelectorAll('[data-jdp]').forEach(el => el.value = '')");
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('miladi_checkin').value = ''; document.getElementById('miladi_checkout').value = ''");
        await LoadVisitors();
    }


    private void ConfirmExit(int id, string name)
   {
        pendingVisitorId = id;
        pendingVisitorName = name;
        confirmModal?.Show("تأیید خروج", $"آیا از خروج {name}اطمینان دارید؟");
    }

    private async Task HandleConfirmResult(bool confirmed)
    {
        if (!confirmed) return;

        var response = await Http.PostAsJsonAsync("api/visitors/ExitVisitor", new { Id = pendingVisitorId });
        if (!response.IsSuccessStatusCode)
        {
            errorMessage = "خطا در ثبت خروج";
        }
        // SignalR خودش حذف می‌کند
    }

    private string GetVisitorImage(string? base64)
    {
        if (string.IsNullOrEmpty(base64)) return "/images/default-avatar.png";
        return $"data:image/jpeg;base64,{base64}";
    }
}