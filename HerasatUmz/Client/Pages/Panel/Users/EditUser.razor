@page "/panel/users/edit/{Id:int}"
@attribute [Authorize(Policy = "AdminOrManager")]
@layout PanelLayout
@inherits BaseComponent
<PageTitle>ویرایش کاربر</PageTitle>


@{
    if (user != null)
    {
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>ویرایش @user.FullName</h1>
                    </div>
                </div>
            </div>
        </section>
    }
}
<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-edit"></i> ویرایش کاربر
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" @onclick="NavigateToUserList">
                        <i class="fas fa-arrow-left"></i> بازگشت
                    </button>
                </div>
            </div>

            <div class="card-body">
                @if (isLoading)
                {
                    <div class="overlay">
                        <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                    </div>
                }
                else if (user == null)
                {
                    <div class="callout callout-warning">
                        <h5><i class="fas fa-ban"></i> کاربر یافت نشد</h5>
                        <p>کاربری با این شناسه وجود ندارد.</p>
                    </div>
                }
                else
                {
                    <!-- مراحل Wizard -->
                    <ul class="nav nav-pills nav-wizard justify-content-center mb-4">
                        <li class="nav-item">
                            <a class="nav-link rounded-pill @(currentStep == 1 ? "active" : "completed")" href="#">۱. شخصی</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link rounded-pill @(currentStep == 2 ? "active" : (currentStep > 2 ? "completed" : ""))" href="#">۲. نقش</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link rounded-pill @(currentStep == 3 ? "active" : "")" href="#">۳. پیش‌نمایش</a>
                        </li>
                    </ul>

                    <EditForm Model="updateUserCommand" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <!-- مرحله ۱: اطلاعات شخصی -->
                        <div class="@(currentStep == 1 ? "" : "d-none")">
                            <div class="row">
                                <!-- نام -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>نام</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.FirstName"
                                                   class="@("form-control " + GetValidationClass("FirstName"))"
                                                   placeholder="نام" />
                                        </div>
                                        @if (validationErrors.ContainsKey("FirstName"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["FirstName"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- نام خانوادگی -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>نام خانوادگی</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.LastName"
                                                   class="@("form-control " + GetValidationClass("LastName"))"
                                                   placeholder="نام خانوادگی" />
                                        </div>
                                        @if (validationErrors.ContainsKey("LastName"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["LastName"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- ایمیل -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>ایمیل</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                            </div>
                                            <input type="email" @bind="updateUserCommand.Email"
                                                   class="@("form-control " + GetValidationClass("Email"))"
                                                   placeholder="example@mail.com" />
                                        </div>
                                        @if (validationErrors.ContainsKey("Email"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["Email"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- شغل -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>شغل</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.JobTitle"
                                                   class="@("form-control " + GetValidationClass("JobTitle"))"
                                                   placeholder="شغل کاربر" />
                                        </div>
                                        @if (validationErrors.ContainsKey("JobTitle"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["JobTitle"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- کد ملی -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>کد ملی</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.CodeId"
                                                   class="@("form-control " + GetValidationClass("CodeId"))"
                                                   placeholder="کد ملی" />
                                        </div>
                                        @if (validationErrors.ContainsKey("CodeId"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["CodeId"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- موبایل -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>موبایل</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.Phone"
                                                   class="@("form-control " + GetValidationClass("Phone"))"
                                                   placeholder="09xxxxxxxxx" />
                                        </div>
                                        @if (validationErrors.ContainsKey("Phone"))
                                        {
                                            <small class="form-text text-danger">@validationErrors["Phone"]</small>
                                        }
                                    </div>
                                </div>

                                <!-- شرکت -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>محل کار</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                            </div>
                                            <input @bind="updateUserCommand.Company"
                                                   class="form-control"
                                                   placeholder="محل کار" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-flat" @onclick="NavigateToUserList">
                                    انصراف
                                </button>
                                <button type="button" class="btn btn-flat btn-primary ml-2" @onclick="NextStep">
                                    بعدی <i class="fas fa-arrow-left ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- مرحله ۲: نقش و وضعیت -->
                        <div class="@(currentStep == 2 ? "" : "d-none")">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>نقش کاربر</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-shield-alt"></i></span>
                                            </div>
                                            <select @bind="updateUserCommand.Role" class="form-control">
                                                @foreach (var r in Enum.GetValues(typeof(UserRole)).Cast<UserRole>())
                                                {
                                                    <option value="@r">@r.GetDescription()</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>وضعیت اکانت</label>
                                        <div class="icheck-primary d-inline ml-2">
                                            <input type="checkbox" id="chkActive" @bind="updateUserCommand.IsActive" />
                                            <label for="chkActive">اکانت فعال باشد</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-flat" @onclick="PreviousStep">
                                    <i class="fas fa-arrow-right mr-2"></i> قبلی
                                </button>
                                <button type="button" class="btn btn-flat btn-primary ml-2" @onclick="NextStep">
                                    بعدی <i class="fas fa-arrow-left ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- مرحله ۳: پیش‌نمایش -->
                        <div class="@(currentStep == 3 ? "" : "d-none")">
                            <div class="card card-success mt-4">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-eye"></i> پیش‌نمایش اطلاعات</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-4"><strong>نام کامل:</strong></div>
                                        <div class="col-8">@updateUserCommand.FirstName @updateUserCommand.LastName</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>ایمیل:</strong></div>
                                        <div class="col-8">@updateUserCommand.Email</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>شغل:</strong></div>
                                        <div class="col-8">@updateUserCommand.JobTitle</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>کد ملی:</strong></div>
                                        <div class="col-8">@updateUserCommand.CodeId</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>نقش:</strong></div>
                                        <div class="col-8">
                                            <span class="badge badge-info">@updateUserCommand.Role.GetDescription()</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>وضعیت:</strong></div>
                                        <div class="col-8">
                                            <span class="badge @(updateUserCommand.IsActive ? "badge-success" : "badge-danger")">
                                                @(updateUserCommand.IsActive ? "فعال" : "غیرفعال")
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-flat" @onclick="PreviousStep">
                                    <i class="fas fa-arrow-right mr-2"></i> قبلی
                                </button>
                                <button type="submit" class="btn btn-success btn-lg ml-3" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <i class="fas fa-spinner fa-spin"></i>
                                    }
                                    else
                                    {
                                        <span>ویرایش</span>

                                    }
                                </button>
                            </div>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</section>

@if (showSuccessMessage)
{
    <div class="callout callout-success position-fixed" style="top:20px;right:20px;z-index:9999;width:350px;">
        <h5><i class="fas fa-check-circle"></i> موفقیت!</h5>
        <p>کاربر با موفقیت به‌روزرسانی شد.</p>
        <button type="button" class="close" @onclick="() => showSuccessMessage = false">
            <span>×</span>
        </button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private UserDto? user;
    private UpdateUserCommand updateUserCommand = new();
    private Dictionary<string, string> validationErrors = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool showSuccessMessage = false;
    private int currentStep = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetAsync($"api/users/{Id}");
            if (response.IsSuccessStatusCode)
            {
                user = await response.Content.ReadFromJsonAsync<UserDto>();
                if (user != null)
                {
                    updateUserCommand = new UpdateUserCommand
                        {
                            Id = user.Id,
                            FirstName = user.FirstName,
                            LastName = user.LastName,
                            Email = user.Email,
                            Phone = user.Phone,
                            Company = user.Company,
                            JobTitle = user.JobTitle,
                            CodeId = user.IdCode,
                            Role = user.Role,
                            IsActive = user.IsActive
                        };
                }
            }
            else
            {
                _AlertService.Show("کاربر یافت نشد.", "هشدار", AlertType.Error);

            }
        }
        catch (Exception ex)
        {
            _AlertService.Show("خطا در بارگذاری: ", "هشدار", AlertType.Error);

        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting) return;

        validationErrors.Clear();
        var step1Ok = await ValidateStep1();
        if (!step1Ok)
        {
            currentStep = 1;
            return;
        }

        try
        {
            isSubmitting = true;
            var res = await Http.PutAsJsonAsync($"api/users/{Id}", updateUserCommand);

            if (res.IsSuccessStatusCode)
            {
                showSuccessMessage = true;
                await Task.Delay(1500);
                Navigation.NavigateTo("/panel/users?toastMessage=کاربر با موفقیت ویرایش شد&toastType=Success");
            }
            else
            {

                _AlertService.Show(await res.Content.ReadAsStringAsync(), "هشدار", AlertType.Error);

            }
        }
        catch (Exception ex)
        {
            _AlertService.Show("خطا در ارتباط با سرور: ", "هشدار", AlertType.Error);

        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ValidateStep1()
    {
        bool ok = true;

        if (string.IsNullOrWhiteSpace(updateUserCommand.FirstName))
        {
            validationErrors["FirstName"] = "نام الزامی است";
            ok = false;
        }

        if (string.IsNullOrWhiteSpace(updateUserCommand.LastName))
        {
            validationErrors["LastName"] = "نام خانوادگی الزامی است";
            ok = false;
        }

        if (string.IsNullOrWhiteSpace(updateUserCommand.JobTitle))
        {
            validationErrors["JobTitle"] = "شغل الزامی است";
            ok = false;
        }

        if (string.IsNullOrWhiteSpace(updateUserCommand.CodeId))
        {
            validationErrors["CodeId"] = "کد ملی الزامی است";
            ok = false;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(updateUserCommand.CodeId, @"^\d{10}$"))
        {
            validationErrors["CodeId"] = "کد ملی باید ۱۰ رقم باشد";
            ok = false;
        }

        if (string.IsNullOrWhiteSpace(updateUserCommand.Email))
        {
            validationErrors["Email"] = "ایمیل الزامی است";
            ok = false;
        }
        else if (!Email.IsValidEmail(updateUserCommand.Email))
        {
            validationErrors["Email"] = "ایمیل نامعتبر است";
            ok = false;
        }

        if (!string.IsNullOrWhiteSpace(updateUserCommand.Phone) && !Phone.IsValidPhone(updateUserCommand.Phone))
        {
            validationErrors["Phone"] = "شماره موبایل نامعتبر است";
            ok = false;
        }

        return ok;
    }

    private string GetValidationClass(string key)
        => validationErrors.ContainsKey(key) ? "is-invalid" : "";

    private async Task NextStep()
    {
        bool ok = currentStep == 1 ? await ValidateStep1() : true;
        if (ok && currentStep < 3)
            currentStep++;
        else if (!ok)
            StateHasChanged();
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
            currentStep--;
    }

    private void NavigateToUserList()
        => Navigation.NavigateTo("/panel/users");
}