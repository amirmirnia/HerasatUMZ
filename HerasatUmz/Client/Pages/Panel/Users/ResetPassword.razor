@page "/panel/users/ResetPassword/{Id:int}"
@attribute [Authorize(Policy = "AdminOrManager")]
@layout PanelLayout
@inherits BaseComponent
<PageTitle>تغییر رمز عبور</PageTitle>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="callout callout-danger">
        <h5><i class="fas fa-exclamation-triangle"></i> خطا</h5>
        <p>@errorMessage</p>
    </div>
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>تغییر رمز عبور @(user?.FullName ?? "")</h1>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-key"></i> تغییر رمز عبور کاربر
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" @onclick="NavigateToUserList">
                        <i class="fas fa-arrow-left"></i> بازگشت
                    </button>
                </div>
            </div>

            <div class="card-body">
                @if (isLoading)
                {
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>در حال بارگذاری...</p>
                    </div>
                }
                else if (user == null)
                {
                    <div class="callout callout-warning">
                        <h5><i class="fas fa-exclamation-circle"></i> کاربر یافت نشد</h5>
                        <p>کاربری با این شناسه وجود ندارد.</p>
                    </div>
                }
                else
                {
                    <EditForm Model="command" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>رمز عبور جدید</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        </div>
                                        <input type="@(showPassword ? "text" : "password")"
                                               @bind="command.NewPassword"
                                               class="form-control @GetValidationClass("NewPassword")"
                                               placeholder="رمز عبور جدید" />
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-secondary"
                                                    @onclick="TogglePasswordVisibility" tabindex="-1">
                                                <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                            </button>
                                        </div>
                                    </div>
                                    @if (validationErrors.ContainsKey("NewPassword"))
                                    {
                                        <small class="form-text text-danger">@validationErrors["NewPassword"]</small>
                                    }
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تکرار رمز عبور</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        </div>
                                        <input type="password"
                                               @bind="command.ConfirmNewPassword"
                                               class="form-control @GetValidationClass("ConfirmNewPassword")"
                                               placeholder="تکرار رمز عبور" />
                                    </div>
                                    @if (validationErrors.ContainsKey("ConfirmNewPassword"))
                                    {
                                        <small class="form-text text-danger">@validationErrors["ConfirmNewPassword"]</small>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- نمایش قدرت رمز عبور -->
                        <div class="callout callout-info">
                            <h5><i class="fas fa-info"></i> رمز عبور قوی</h5>
                            <p>رمز باید شامل موارد زیر باشد:</p>
                            <ul class="mb-0">
                                <li class="@(ValidPassword.HasUppercase(command.NewPassword) ? "text-success" : "text-muted")">
                                    <i class="fas fa-check"></i> حداقل یک حرف بزرگ
                                </li>
                                <li class="@(ValidPassword.HasLowercase(command.NewPassword) ? "text-success" : "text-muted")">
                                    <i class="fas fa-check"></i> حداقل یک حرف کوچک
                                </li>
                                <li class="@(ValidPassword.HasNumber(command.NewPassword) ? "text-success" : "text-muted")">
                                    <i class="fas fa-check"></i> حداقل یک عدد
                                </li>
                                <li class="@(ValidPassword.HasSpecialChar(command.NewPassword) ? "text-success" : "text-muted")">
                                    <i class="fas fa-check"></i> حداقل یک کاراکتر خاص
                                </li>
                            </ul>
                        </div>

                        <!-- پیش‌نمایش اطلاعات کاربر -->
                        <div class="card card-success mt-4">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fas fa-user"></i> اطلاعات کاربر</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-4"><strong>نام کامل:</strong></div>
                                    <div class="col-8">@user.FullName</div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>ایمیل:</strong></div>
                                    <div class="col-8">@user.Email</div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>کد ملی:</strong></div>
                                    <div class="col-8">@user.IdCode</div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>موبایل:</strong></div>
                                    <div class="col-8">@user.Phone</div>
                                </div>
                            </div>
                        </div>

                        <div class="text-right mt-4">
                            <button type="button" class="btn  btn-outline-primary btn-lg" @onclick="NavigateToUserList">
                                انصراف
                            </button>
                            <button type="submit" class="btn btn-success btn-lg ml-3" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <i class="fas fa-spinner fa-spin"></i>
                                }
                                else
                                {
                                    <i class="fas fa-save"></i>
                                }
                                ذخیره رمز عبور
                            </button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</section>

@if (showSuccessMessage)
{
    <div class="callout callout-success position-fixed" style="top:20px;right:20px;z-index:9999;width:350px;">
        <h5><i class="fas fa-check-circle"></i> موفقیت!</h5>
        <p>رمز عبور با موفقیت تغییر یافت.</p>
        <button type="button" class="close" @onclick="() => showSuccessMessage = false">
            <span>×</span>
        </button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private UserDto? user;
    private ResetpasswordUserCommand command = new();
    private Dictionary<string, string> validationErrors = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool showSuccessMessage = false;
    private bool showPassword = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetAsync($"api/users/{Id}");
            if (response.IsSuccessStatusCode)
            {
                user = await response.Content.ReadFromJsonAsync<UserDto>();
                command = new ResetpasswordUserCommand
                    {
                        IdCode = user.IdCode
                    };
            }
            else
            {
                errorMessage = "کاربر یافت نشد.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "خطا در دریافت اطلاعات کاربر: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting) return;

        validationErrors.Clear();
        if (!await ValidateForm()) return;

        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;

            var response = await Http.PostAsJsonAsync($"api/users/{Id}/change-password", command);

            if (response.IsSuccessStatusCode)
            {
                showSuccessMessage = true;
                await Task.Delay(1500);
                Navigation.NavigateTo("/panel/users");
            }
            else
            {
                errorMessage = await response.Content.ReadAsStringAsync();
                if (string.IsNullOrWhiteSpace(errorMessage))
                    errorMessage = "خطا در تغییر رمز عبور.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "خطا در ارتباط با سرور: " + ex.Message;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ValidateForm()
    {
        bool ok = true;

        if (string.IsNullOrWhiteSpace(command.NewPassword))
        {
            validationErrors["NewPassword"] = "رمز عبور الزامی است";
            ok = false;
        }
        else if (!ValidPassword.IsStrongPassword(command.NewPassword))
        {
            validationErrors["NewPassword"] = "رمز عبور باید قوی باشد";
            ok = false;
        }

        if (command.NewPassword != command.ConfirmNewPassword)
        {
            validationErrors["ConfirmNewPassword"] = "رمز عبور و تکرار آن یکسان نیستند";
            ok = false;
        }

        return ok;
    }

    private string GetValidationClass(string key) => validationErrors.ContainsKey(key) ? "is-invalid" : "";

    private void TogglePasswordVisibility() => showPassword = !showPassword;

    private void NavigateToUserList() => Navigation.NavigateTo("/panel/users");
}