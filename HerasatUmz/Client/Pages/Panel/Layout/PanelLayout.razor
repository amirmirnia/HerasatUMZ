@inherits LayoutComponentBase
@attribute [Authorize(Policy = "AdminOrManagerOrPaymentUser")]
@inject NavigationManager Navigation
@inject HttpClient Http
@inject UserContextService UserContext
@using Client.Components.Alert
@using Client.Services.Log
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider



<AlertContainer />
<VisitTracker />
<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand bg-white navbar-light border-bottom">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="/Panel" class="nav-link">خانه</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a @onclick="LogOut" class="nav-link">خروج</a>
                </li>
            </ul>
        </nav>

        <!-- Sidebar -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="/panel" class="brand-link">
                <span class="brand-text font-weight-light">برنامه مدیریت دیدبان</span>
            </a>

            <div class="sidebar">
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="/LogoWhite.png" class="img-circle elevation-2" alt="User Image">
                    </div>
                    <div class="info">
                        <a class="d-block">@UserContext.Name</a>
                    </div>
                </div>

                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">

                        <!-- داشبورد - همه می‌بینند -->
                        <li class="nav-item">
                            <a href="/panel" class="nav-link">
                                <i class="nav-icon fa fa-dashboard"></i>
                                <p>داشبورد</p>
                            </a>
                        </li>

                        <!-- فقط Admin/Manager -->
                        <AuthorizeView Policy="AdminOrManager">
                            <li class="nav-item">
                                <a href="/panel/users" class="nav-link">
                                    <i class="nav-icon fa fa-users"></i>
                                    <p>لیست اعضا</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/panel/users/create" class="nav-link">
                                    <i class="nav-icon fa fa-user-plus"></i>
                                    <p>ایجاد اعضا</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/panel/logs" class="nav-link">
                                    <i class="nav-icon fa fa-warning"></i>
                                    <p>لاگ برنامه</p>
                                </a>
                            </li>
                        </AuthorizeView>

                        <!-- مانیتورینگ - همه می‌بینند -->
                        <li class="nav-item">
                            <a href="/Panel/visitors" class="nav-link">
                                <i class="nav-icon fa fa-th"></i>
                                <p>مانیتورینگ</p>
                            </a>
                        </li>

                            <li class="nav-item">
                                <a href="/panel/visitors/create" class="nav-link">
                                    <i class="nav-icon fa fa-plus-square-o"></i>
                                    <p>ثبت ملاقاتی</p>
                                </a>
                            </li>

                        <!-- لیست افراد خارج شده - همه می‌بینند -->
                        <li class="nav-item">
                            <a href="/Panel/visitors/ListExitedVisitors" class="nav-link">
                                <i class="fa fa-sign-out"></i>
                                <p>لیست افراد خارج شده</p>
                            </a>
                        </li>

                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Content -->
        <div class="content-wrapper">
            @Body
        </div>

        <!-- Footer -->
        <footer class="main-footer">
            <strong>تیم نرم افزاری مرکز فناوری اطلاعات-پشتیبانی:امیرحسین میرنیا 2889</strong>
        </footer>
    </div>
</body>

@code {
    protected override async Task OnInitializedAsync()
    {
        await UserContext.InitializeAsync();
        await base.OnInitializedAsync();
        StateHasChanged();
    }

    private async Task LogOut()
    {
        try
        {
            await Http.PostAsync("api/auth/logout", null);
        }
        catch { /* ignore */ }
        Navigation.NavigateTo("/");
    }
}